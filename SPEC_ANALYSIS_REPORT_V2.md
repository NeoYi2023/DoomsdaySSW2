# SPEC文档分析报告 V2

## 分析日期
2024-12-16（第二次全面分析）

## 一、逻辑冲突分析

### 1.1 探索空间内移动与行动规则不明确
**问题**：
- 7.1 探索流程提到"进行探索操作（移动、采集、战斗）"
- 3.1 回合运作流程提到"探险内计算（移动、探索、战斗等）"
- 但SPEC中未明确说明探索空间内的移动是否消耗体力、是否消耗回合

**冲突点**：
- 大地图移动：每回合移动1格，消耗1回合
- 探索空间内移动：规则未定义，可能导致实现时产生歧义
- 如果探索空间内移动不消耗回合，那么玩家可以在一个回合内无限移动？

**解决方案**：
- 在7.3探索空间规则中新增"移动与行动规则"：
  - 探索空间内的移动采用回合制（与大地图移动保持一致）
  - 每次在探索空间内移动1格，需要点击"下一回合"才能继续移动
  - 探索空间内的移动不额外消耗体力（体力已在回合开始时统一扣除）
  - 采集操作需要角色移动到垃圾格子，然后进行采集（采集操作不消耗额外回合）

### 1.2 战斗目标选择规则不明确
**问题**：
- 8.1 战斗规则说明了攻击顺序（按格子编号由小到大）
- 8.2 战斗流程提到"对每个格子中的角色，攻击其攻击范围内的怪物"
- 但未说明如果攻击范围内有多个怪物，角色如何选择攻击目标

**冲突点**：
- 如果角色攻击范围内有3个怪物，应该攻击哪个？
- 如果怪物攻击范围内有3个角色，应该攻击哪个？

**解决方案**：
- 在8.1战斗规则中补充"目标选择规则"：
  - 角色攻击阶段：如果角色攻击范围内有多个怪物，优先攻击血量最低的怪物；如果血量相同，则按格子编号由小到大选择
  - 怪物攻击阶段：如果怪物攻击范围内有多个角色，优先攻击血量最低的角色；如果血量相同，则按格子编号由小到大选择

### 1.3 探索空间内战斗触发时机不明确
**问题**：
- 8.1 战斗规则提到"每个回合开始时，系统检测所有角色的攻击范围内是否有怪物，如果有则触发战斗"
- 但未说明探索空间内的移动是否会触发新的战斗检测

**冲突点**：
- 如果角色在探索空间内移动，移动到新的位置后，攻击范围内出现怪物，是否立即触发战斗？
- 还是只在回合开始时检测一次？

**解决方案**：
- 在8.1战斗规则中明确：
  - 战斗检测时机：每个回合开始时检测一次（在"探险内计算"阶段之前）
  - 探索空间内的移动不会触发新的战斗检测（战斗只在回合开始时检测）
  - 如果回合开始时检测到战斗，则先进行战斗计算，战斗结束后才能进行探索空间内的移动

### 1.4 探索进度系统不明确
**问题**：
- 4.3 格子数据结构提到 `explorationProgress`（探索进度0-100）
- 4.2 格子状态转换提到"探索进度达到100%"后转换为空地
- 但未说明何时增加、如何增加探索进度

**冲突点**：
- 探索进度何时增加？是完成一层增加？还是完成整个探索点增加？
- 增加多少？是固定值还是按配置？

**解决方案**：
- 在7.3探索空间规则中补充"探索进度规则"：
  - 每次完成探索空间的一层，对应地图格子的探索进度增加（增加量在 `ExplorationPointConfig` 中配置，如每层+25%）
  - 如果探索点有3层，完成第1层后探索进度+25%，完成第2层后+25%，完成第3层后+25%，总计75%
  - 探索进度达到100%后，探索点转换为空地（详见4.2格子状态转换）

### 1.5 角色升级系统缺失
**问题**：
- 9.4 资源使用提到"角色升级：消耗资源"
- 10.1 避难所功能提到"角色升级：提升角色属性"
- 但未说明如何升级、升级什么、升级条件、升级效果

**冲突点**：
- 无法实现角色成长系统
- 玩家无法提升角色能力

**解决方案**：
- 新增"5.7 角色升级系统"：
  - 升级方式：在避难所界面选择角色，消耗特定资源进行升级
  - 可升级属性：最大血量、最大体力、攻击力、背包容量
  - 升级条件：需要消耗特定资源（在配置表中定义，如需要"升级材料"资源）
  - 升级效果：按固定数值提升（如最大血量+1，最大体力+5，攻击力+1，背包容量+2）
  - 升级上限：每个属性有最大上限（在配置表中定义）

### 1.6 科技树效果数值缺失
**问题**：
- 5.4.1 科技树分支提到各种效果（增加战斗力、增加背包容量等）
- 但未说明具体数值（增加多少、如何计算）

**冲突点**：
- 无法实现科技树系统
- 无法进行数值平衡

**解决方案**：
- 在TechTreeConfig配置表中明确：
  - 效果类型（枚举值：如 `IncreaseMaxHP`, `IncreaseInventoryCapacity`, `IncreaseAttack` 等）
  - 效果数值（具体数值或百分比，如 `+5` 或 `+10%`）
  - 效果计算方式（加法、乘法、百分比）
  - 效果叠加规则（相同效果是否叠加）

### 1.7 天赋效果系统缺失
**问题**：
- 5.3 天赋系统提到"被动技能、属性加成、特殊能力"
- 但未说明天赋的具体效果、如何生效

**冲突点**：
- 无法实现天赋系统
- 无法设计角色差异化

**解决方案**：
- 新增"5.3.1 天赋效果规则"：
  - 天赋效果类型：属性加成（如+1攻击力）、技能效果（如采集时额外获得资源）、特殊能力（如免疫某种状态）
  - 天赋生效时机：常驻（属性加成）、战斗时、采集时、探索时等
  - 天赋效果数值：在配置表中定义（需要新增TalentConfig配置表）
  - 天赋效果叠加：相同天赋效果是否叠加（在配置表中定义）

### 1.8 配置表关联关系缺失
**问题**：
- 11.1 配置表清单列出了8个配置表
- 但未说明配置表之间的关联关系（如ExplorerConfig如何引用TalentConfig）

**冲突点**：
- 无法正确设计配置表结构
- 可能导致数据不一致

**解决方案**：
- 在11.1配置表清单中为每个配置表补充"关联配置表"说明：
  - ExplorerConfig：引用TalentConfig（初始天赋ID列表）、TechTreeConfig（初始科技树解锁项ID列表）
  - ExplorationPointConfig：引用MonsterConfig（怪物生成规则中的怪物ID列表）、ResourceConfig（垃圾生成规则中的资源ID列表）
  - TechTreeConfig：引用ResourceConfig（解锁条件中的资源ID列表）、ItemConfig（解锁条件中的道具ID列表）
  - ShelterLevelConfig：引用FacilityConfig（设施ID列表，需要新增此配置表）

### 1.9 存档数据结构不完整
**问题**：
- 13.1 存档数据结构列出了基本结构
- 但未包含临时背包状态、死亡物品等数据

**冲突点**：
- 无法完整保存游戏状态
- 可能导致数据丢失

**解决方案**：
- 在13.1存档数据结构中补充：
  ```csharp
  List<Item> tempInventory;        // 临时背包
  bool isTempInventoryLocked;      // 临时背包锁定状态
  List<DeathItemData> deathItems;  // 死亡角色物品（包含位置、死亡回合等）
  // DeathItemData 包含：位置、物品列表、死亡回合数、死亡角色ID
  ```

### 1.10 探索空间内采集规则不明确
**问题**：
- 9.2 资源收集规则提到"采集获得的资源"
- 7.3 探索空间规则提到"垃圾生成：原始物资，需要通过角色特长天赋采集"
- 但未说明如何采集、是否消耗体力、是否消耗回合

**冲突点**：
- 无法实现采集功能
- 玩家不知道如何操作

**解决方案**：
- 在7.3探索空间规则中补充"采集规则"：
  - 采集条件：角色需要移动到垃圾格子，且角色拥有对应的采集天赋
  - 采集操作：玩家点击垃圾格子，选择"采集"操作
  - 采集消耗：采集操作不消耗额外回合（在同一回合内完成），但可能消耗体力（在配置表中定义）
  - 采集结果：根据角色天赋、科技树加成计算采集获得的资源数量和种类

---

## 二、重要缺失功能分析

### 2.1 探索空间内移动与行动规则缺失
**缺失内容**：
- 探索空间内移动是否消耗回合
- 探索空间内移动是否消耗体力
- 探索空间内的回合概念

**影响**：
- 无法实现探索空间内的玩法
- 可能导致实现时产生歧义

**解决方案**：
- 在7.3探索空间规则中新增"移动与行动规则"（详见1.1）

### 2.2 战斗目标选择规则缺失
**缺失内容**：
- 多目标时的选择规则
- 目标优先级

**影响**：
- 无法实现战斗系统
- 战斗体验不明确

**解决方案**：
- 在8.1战斗规则中补充"目标选择规则"（详见1.2）

### 2.3 探索进度系统缺失
**缺失内容**：
- 探索进度何时增加
- 探索进度增加多少
- 探索进度达到100%后的处理

**影响**：
- 无法实现探索点的探索进度功能
- 4.2格子状态转换无法触发

**解决方案**：
- 在7.3探索空间规则中补充"探索进度规则"（详见1.4）

### 2.4 角色升级系统缺失
**缺失内容**：
- 如何升级
- 升级什么
- 升级条件
- 升级效果

**影响**：
- 无法实现角色成长系统
- 玩家无法提升角色能力

**解决方案**：
- 新增"5.7 角色升级系统"（详见1.5）

### 2.5 科技树效果数值缺失
**缺失内容**：
- 科技树效果的具体数值
- 效果计算方式

**影响**：
- 无法实现科技树系统
- 无法进行数值平衡

**解决方案**：
- 在TechTreeConfig配置表中明确效果数值（详见1.6）

### 2.6 天赋效果系统缺失
**缺失内容**：
- 天赋的具体效果
- 天赋如何生效

**影响**：
- 无法实现天赋系统
- 无法设计角色差异化

**解决方案**：
- 新增"5.3.1 天赋效果规则"（详见1.7）

### 2.7 配置表关联关系缺失
**缺失内容**：
- 配置表之间的ID引用关系
- 数据一致性要求

**影响**：
- 无法正确设计配置表结构
- 可能导致数据不一致

**解决方案**：
- 在11.1配置表清单中补充关联关系说明（详见1.8）

### 2.8 存档数据结构不完整
**缺失内容**：
- 临时背包状态
- 死亡物品数据

**影响**：
- 无法完整保存游戏状态
- 可能导致数据丢失

**解决方案**：
- 在13.1存档数据结构中补充缺失字段（详见1.9）

### 2.9 探索空间内采集规则缺失
**缺失内容**：
- 如何采集
- 是否消耗体力
- 是否消耗回合

**影响**：
- 无法实现采集功能
- 玩家不知道如何操作

**解决方案**：
- 在7.3探索空间规则中补充"采集规则"（详见1.10）

---

## 三、建议补充的章节

### 3.1 新增章节建议

1. **5.3.1 天赋效果规则**（新增）
   - 天赋效果类型
   - 天赋生效时机
   - 天赋效果计算
   - 天赋效果叠加

2. **5.7 角色升级系统**（新增）
   - 升级条件
   - 升级消耗
   - 升级效果
   - 升级上限

3. **7.3.1 探索空间内移动与行动规则**（新增子章节）
   - 移动规则
   - 行动消耗
   - 采集规则

4. **7.3.2 探索进度规则**（新增子章节）
   - 探索进度增加时机
   - 探索进度增加量
   - 探索进度达到100%后的处理

5. **8.1.1 战斗目标选择规则**（新增子章节）
   - 角色攻击目标选择
   - 怪物攻击目标选择
   - 目标优先级

6. **11.3 配置表关联关系**（新增）
   - 配置表之间的ID引用关系
   - 数据一致性要求
   - 配置表验证规则

---

## 四、优先级建议

### 高优先级（必须解决）
1. 探索空间内移动与行动规则（1.1, 2.1）
2. 战斗目标选择规则（1.2, 2.2）
3. 探索空间内采集规则（1.10, 2.9）
4. 探索进度系统（1.4, 2.3）
5. 角色升级系统（1.5, 2.4）

### 中优先级（建议解决）
1. 科技树效果数值（1.6, 2.5）
2. 天赋效果系统（1.7, 2.6）
3. 配置表关联关系（1.8, 2.7）
4. 存档数据结构完善（1.9, 2.8）

### 低优先级（可后续完善）
1. 探索空间内战斗触发时机（1.3）

---

## 五、具体修改建议

### 5.1 立即修改项

1. **在7.3探索空间规则中新增"移动与行动规则"子章节**
2. **在7.3探索空间规则中新增"探索进度规则"子章节**
3. **在7.3探索空间规则中新增"采集规则"子章节**
4. **在8.1战斗规则中新增"目标选择规则"子章节**
5. **新增5.7 角色升级系统章节**
6. **新增5.3.1 天赋效果规则子章节**
7. **在11.1配置表清单中补充关联关系说明**
8. **在13.1存档数据结构中补充缺失字段**

### 5.2 新增内容项

1. **新增7.3.1 探索空间内移动与行动规则**
2. **新增7.3.2 探索进度规则**
3. **新增8.1.1 战斗目标选择规则**
4. **新增5.7 角色升级系统**
5. **新增5.3.1 天赋效果规则**
6. **新增11.3 配置表关联关系**

---

## 六、总结

### 发现的逻辑冲突：10个
1. 探索空间内移动与行动规则不明确
2. 战斗目标选择规则不明确
3. 探索空间内战斗触发时机不明确
4. 探索进度系统不明确
5. 角色升级系统缺失
6. 科技树效果数值缺失
7. 天赋效果系统缺失
8. 配置表关联关系缺失
9. 存档数据结构不完整
10. 探索空间内采集规则不明确

### 发现的缺失功能：9个
1. 探索空间内移动与行动规则
2. 战斗目标选择规则
3. 探索进度系统
4. 角色升级系统
5. 科技树效果数值
6. 天赋效果系统
7. 配置表关联关系
8. 存档数据结构不完整
9. 探索空间内采集规则

### 建议新增章节：6个
1. 5.3.1 天赋效果规则
2. 5.7 角色升级系统
3. 7.3.1 探索空间内移动与行动规则
4. 7.3.2 探索进度规则
5. 8.1.1 战斗目标选择规则
6. 11.3 配置表关联关系

---

**报告结束**
